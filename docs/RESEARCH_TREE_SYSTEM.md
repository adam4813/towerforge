# Research and Upgrade Tree System

## Overview

The Research and Upgrade Tree system allows players to spend **Tower Points** to unlock new facility types, improve elevator performance, and gain various bonuses that enhance gameplay.

**Tower Points** are generated by hiring management staff and building management facilities rather than traditional milestone-based rewards. This creates meaningful progression tied to your tower's management infrastructure.

## Features

### Tower Points System

**Tower Points** replace the old research points system:

- **Generation**: Earned by hiring management staff (executives, managers, analysts)
- **Management Facilities**: Staff work in ManagementOffice and SatelliteOffice facilities
- **Rate**: 1 Tower Point per hour per management staff member
- **Purpose**: Spent on research nodes to unlock features and bonuses

### Research Tree Structure

The research tree is organized in a 3-row grid layout with progressively more powerful upgrades:

- **Row 0 (Basic Tier)**: Starter upgrades and management infrastructure
- **Row 1 (Mid Tier)**: Intermediate upgrades and advanced facilities
- **Row 2 (Advanced Tier)**: Powerful end-game upgrades and elite facilities

### Node Types

1. **Facility Unlocks**: Unlock new building types
   - Office Spaces
   - Retail Shops
   - Management Offices (generates tower points)
   - Satellite Offices (additional management capacity)
   - Restaurants
   - Arcades
   - Gyms
   - (More can be added via Lua mods)

2. **Elevator Improvements**:
   - Fast Elevators: +50% speed
   - Express Elevators: +100% speed
   - Large Elevators: +4 capacity

3. **Economic Bonuses**:
   - Revenue Optimization: +25% income
   - Efficient Building: -20% costs

4. **Operational Improvements**:
   - Rapid Construction: +50% build speed
   - Quality Service: +10 satisfaction points

### Node States

Each research node can be in one of four states:

- **❓ Hidden**: Prerequisites for visibility not met (e.g., star rating too low)
- **🔒 Locked**: Visible but cannot unlock yet (insufficient points or prerequisites)
- **✨ Upgradable**: Can be unlocked (prerequisites met, enough tower points)
- **✅ Unlocked**: Already unlocked and providing benefits

### Conditional Prerequisites

Research nodes can now have advanced prerequisites beyond just other research:

1. **Research Prerequisites**: Other nodes that must be unlocked first
2. **Star Rating**: Minimum tower star rating required
3. **Population**: Minimum tower population required
4. **Facilities**: Specific facilities that must exist in the tower

## User Interface

### Opening the Research Tree

- Press **R** during gameplay to toggle the research tree menu
- Press **ESC** while in the research tree to close it

### Menu Layout

```
┌─────────────────────────────────────────────────────────────────┐
│                 RESEARCH/UPGRADE TREE                           │
│ Tower Points: 50      Total Earned: 100    Generation: 5 pts/hr│
│ Management Staff: 5                                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌────┐  ┌────┐  ┌────┐  ┌────┐                               │
│  │ 🚀 │  │ 🏢 │  │ 🏪 │  │ 🏛️ │   Row 0: Basic Tier          │
│  │ 10 │  │  5 │  │  5 │  │ 15 │                               │
│  └────┘  └────┘  └────┘  └────┘                               │
│     ↑       ↑       ↑       ↑                                  │
│  ┌────┐  ┌────┐  ┌────┐  ┌────┐  ┌────┐                      │
│  │ ⚡ │  │ 📦 │  │ 💰 │  │ 🏢 │  │ 🍽️ │   Row 1: Mid Tier    │
│  │ 20 │  │ 15 │  │ 15 │  │ 25 │  │ 30 │                      │
│  └────┘  └────┘  └────┘  └────┘  └────┘                      │
│                                                                 │
│  ┌────┐  ┌────┐  ┌────┐  ┌────┐  ┌────┐                      │
│  │ 🏗️ │  │ 📉 │  │ 😊 │  │ 🎮 │  │ 💪 │   Row 2: Advanced    │
│  │ 25 │  │ 30 │  │ 25 │  │ 35 │  │ 40 │                      │
│  └────┘  └────┘  └────┘  └────┘  └────┘                      │
│                                                                 │
│ ┌─────────────────────────┐                                    │
│ │ Node Details:           │  (Hover over node to see)          │
│ │                         │                                    │
│ │ Tower Management        │                                    │
│ │ Status: Locked 🔒       │                                    │
│ │ Cost: 15 points         │                                    │
│ │                         │                                    │
│ │ Description:            │                                    │
│ │ Unlock management       │                                    │
│ │ office to generate      │                                    │
│ │ tower points            │                                    │
│ │                         │                                    │
│ │ Unlock Conditions:      │                                    │
│ │ - Min. 20 population    │                                    │
│ │                         │                                    │
│ │ Effect:                 │                                    │
│ │ Unlocks ManagementOffice│                                    │
│ └─────────────────────────┘                                    │
└─────────────────────────────────────────────────────────────────┘
```

### Interacting with Nodes

1. **Hover** over a node to see detailed information in the details panel
2. **Click** on an upgradable node (✨) to unlock it
3. Unlocked nodes (✅) provide immediate benefits
4. Locked nodes (🔒) show prerequisites, costs, and unlock conditions
5. Hidden nodes (❓) appear when visibility prerequisites are met

## Default Research Tree

### Row 0 - Basic Tier

| Node | Name | Type | Cost | Prerequisites | Unlock Conditions | Effect |
|------|------|------|------|---------------|-------------------|--------|
| 🚀 | Fast Elevators | Elevator Speed | 10 | - | - | +50% elevator speed |
| 🏢 | Office Spaces | Facility Unlock | 5 | - | - | Unlock office facilities |
| 🏪 | Retail Shops | Facility Unlock | 5 | - | - | Unlock retail shops |
| 🏛️ | Tower Management | Facility Unlock | 15 | - | 20+ population | Unlock management office |

### Row 1 - Mid Tier

| Node | Name | Type | Cost | Prerequisites | Unlock Conditions | Effect |
|------|------|------|------|---------------|-------------------|--------|
| ⚡ | Express Elevators | Elevator Speed | 20 | Fast Elevators | - | +100% elevator speed |
| 📦 | Large Elevators | Elevator Capacity | 15 | Fast Elevators | - | +4 capacity |
| 💰 | Revenue Optimization | Income Bonus | 15 | Office Spaces | - | +25% income |
| 🏢 | Branch Management | Facility Unlock | 25 | Tower Management | 2-star rating | Unlock satellite office |
| 🍽️ | Fine Dining | Facility Unlock | 30 | Retail Shops | 2-star, 50+ pop | Unlock restaurant |

### Row 2 - Advanced Tier

| Node | Name | Type | Cost | Prerequisites | Unlock Conditions | Effect |
|------|------|------|------|---------------|-------------------|--------|
| 🏗️ | Rapid Construction | Construction Speed | 25 | - | 3-star rating | +50% build speed |
| 📉 | Efficient Building | Cost Reduction | 30 | - | Have management office | -20% costs |
| 😊 | Quality Service | Satisfaction Bonus | 25 | Revenue Optimization | - | +10 satisfaction |
| 🎮 | Gaming Entertainment | Facility Unlock | 35 | Fine Dining | 3-star, 100+ pop | Unlock arcade |
| 💪 | Wellness Center | Facility Unlock | 40 | Fine Dining | 3-star, 75+ pop | Unlock gym |

## Save/Load Support

Research progress is automatically saved and restored:

- Unlocked nodes and their states
- Research points (available and total earned)
- Global bonuses applied (multipliers, bonuses)

When loading a save:
1. The research tree is reinitialized with default nodes
2. Previously unlocked nodes are restored
3. Bonuses are reapplied automatically
4. Node states are updated based on current conditions

## Implementation Details

### Components

**ResearchNode**: Individual node in the tree
```cpp
struct ResearchNode {
    std::string id;
    std::string name;
    std::string description;
    std::string icon;
    ResearchNodeType type;
    ResearchNodeState state;
    int cost;                          // Tower points required
    std::vector<std::string> prerequisites;
    
    // Conditional prerequisites
    int min_star_rating;               // Minimum tower star rating
    int min_population;                // Minimum tower population
    std::vector<std::string> required_facilities;  // Facilities that must exist
    
    int grid_row;
    int grid_column;
    float effect_value;
    std::string effect_target;
};
```

**ResearchTree**: Singleton managing the entire tree
```cpp
struct ResearchTree {
    int tower_points;                  // Available points to spend
    int total_points_earned;           // Lifetime points earned
    std::vector<ResearchNode> nodes;   // All research nodes
    
    // Management staff tracking
    int management_staff_count;        // Total management staff
    float tower_points_per_hour;       // Current generation rate
    float accumulated_points;          // Fractional points
    
    // Global bonuses
    float income_multiplier;
    float satisfaction_bonus;
    float construction_speed_multiplier;
    float cost_reduction;
    float elevator_speed_multiplier;
    int elevator_capacity_bonus;
};
```

### Systems

**Tower Points Generation System**: Generates points from management staff
- Runs every second
- Counts staff in ManagementOffice and SatelliteOffice facilities
- Generates points: `staff_count * 1 point/hour * elapsed_time`
- Awards whole points and accumulates fractional points

### API

**Unlocking Nodes**:
```cpp
ResearchTree& research = world.get_mut<ResearchTree>();
bool success = research.UnlockNode("node_id");
```

**Checking Facility Unlocks**:
```cpp
bool unlocked = research.IsFacilityUnlocked("Office");
```

**Awarding Points** (for special events):
```cpp
research.AwardPoints(10);
```

**Generating Tower Points** (automatic):
```cpp
// Called automatically by the system
research.GenerateTowerPoints(delta_hours);
research.UpdateManagementStaffCount(staff_count);
```

**Checking Prerequisites**:
```cpp
// Check if node can be unlocked
bool can_unlock = research.CanUnlock(node, star_rating, population, built_facilities);

// Check if node is visible
bool visible = research.IsVisible(node, star_rating, population);
```

## Lua API for Mods

Mods can register custom research nodes:

```lua
TowerForge.RegisterResearchNode({
    id = "unique_id",
    name = "Display Name",
    description = "Node description",
    icon = "🎯",
    type = "FacilityUnlock",  -- Or other types
    cost = 30,
    grid_row = 1,
    grid_column = 3,
    effect_value = 0.25,
    effect_target = "Hotel",
    prerequisites = {"office_unlock"},
    min_star_rating = 2,
    min_population = 50,
    required_facilities = {"Restaurant"}
})
```

### Node Types for Lua

- `"FacilityUnlock"`: Unlocks a building type
- `"ElevatorSpeed"`: Increases elevator speed
- `"ElevatorCapacity"`: Increases elevator capacity
- `"IncomeBonus"`: Increases income
- `"SatisfactionBonus"`: Increases satisfaction
- `"ConstructionSpeed"`: Faster construction
- `"CostReduction"`: Reduces costs

## Future Enhancements

Potential improvements:

1. **Dynamic Trees**: Allow multiple tech tree configurations
2. **More Node Types**: Add new upgrade categories
3. **Visual Effects**: Add animations when unlocking nodes
4. **Achievements**: Special nodes for completing challenges
5. **Research Specializations**: Branch paths for different playstyles
6. **Management Bonuses**: Upgrades that increase tower points generation rate
7. **Reset/Respec**: Allow players to reset tree and refund points
8. **Tooltips**: Enhanced tooltips with statistics and recommendations
9. **Notification System**: Alert players when new nodes become available

## Related Documentation

- See `docs/TOWER_POINTS_SYSTEM.md` for detailed information about Tower Points generation and management facilities
- See `mods/example_hotel_research.lua` and `mods/example_advanced_research.lua` for Lua modding examples

## Files

### Headers
- `include/core/components.hpp` - ResearchNode and ResearchTree structures
- `include/ui/research_tree_menu.h` - UI menu class
- `include/core/lua_mod_manager.hpp` - Lua API for research nodes

### Implementation
- `src/ui/research_tree_menu.cpp` - UI rendering and interaction
- `src/core/ecs_world.cpp` - Tower points generation system
- `src/core/save_load_manager.cpp` - Serialization/deserialization
- `src/core/lua_mod_manager.cpp` - Lua API implementation

### Documentation
- `docs/TOWER_POINTS_SYSTEM.md` - Tower Points system documentation
- `docs/RESEARCH_TREE_SYSTEM.md` - This file

### Example Mods
- `mods/example_hotel_research.lua` - Hotel unlock example
- `mods/example_advanced_research.lua` - Advanced research nodes with complex prerequisites

### Demo
- `research_tree_demo.png` - Screenshot of the UI

## License

Part of TowerForge - see main project LICENSE.
